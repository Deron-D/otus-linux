---
- hosts: all # part running on all hosts
  become: true
  tasks:

  - name: Install epel-release # переведём синтаксис yum из deprecated
    yum:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
      - epel-release
  
  pre_tasks:
  - name: Modify /etc/hosts
    lineinfile:
      path: /etc/hosts
      line: '{{ item.node_ip }} {{ item.node }}.{{ item.domain }} {{ item.node }}'
    with_items:
      - "{{ nodes }}"
    tags:
      - etc_hosts_modify

- name: Установка postgres11
  hosts: master, slave, backup
  become: yes
  roles:
    - postgres_install

- name: Настройка master
  hosts: master
  become: yes
  roles:
    - master-setup
    
- name: Настройка slave
  hosts: slave
  become: yes
  roles:
    - slave-setup

- name: Создание тестовой БД
  hosts: master
  become: yes
  roles:
    - create_test_db

- name: Настройка barman
  hosts: backup
  become: yes
  roles:
    - barman_install
  tags:
    - barman

      #- name: Configure Prometheus + Node Exporter + Grafana
      #hosts: monlog
      #become: yes
      #roles:
    #    - base_config
    - cloudalchemy.prometheus
    - cloudalchemy.node-exporter
    - cloudalchemy.grafana
      #vars:
      #prometheus_targets:
      #node:
      #- targets: 
      #    "{{ targets }}"
      #  labels:
      #    env: otusproject
      #tags:
      #- prometheus_install

      #- name: Установка cloudalchemy.node-exporter
      #hosts: master, slave, backup, monlog
      #become: yes
      #roles:
      #- cloudalchemy.node-exporter
      #tags:
      #- nodeexporter

